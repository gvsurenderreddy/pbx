;GENERAL

[GETEMPNAME]
dsn=asterisk
readsql=SELECT name FROM structure_employee WHERE id = '${SQL_ESC(${ARG1})}'

[GETPHONAME]
dsn=asterisk
readsql=SELECT name FROM structure_phone WHERE id = '${SQL_ESC(${ARG1})}'

[GETEMPNUM]
dsn=asterisk
readsql=SELECT extension FROM structure_employee WHERE id = '${SQL_ESC(${ARG1})}'

[GETSUBNUM]
dsn=asterisk
readsql=SELECT number FROM structure_subscription WHERE id = '${SQL_ESC(${ARG1})}'

;--------------------------------------

;HD

[HDGETCOM]
dsn=asterisk
readsql=SELECT structure_company.id FROM structure_company LEFT JOIN structure_phone ON structure_phone.company_id = structure_company.id WHERE structure_phone.hash = '${SQL_ESC(${ARG1})}';

[HDGETEMP]
dsn=asterisk
readsql=SELECT id FROM structure_employee WHERE extension = ${SQL_ESC(${ARG1})} AND company_id = ${SQL_ESC(${ARG2})} AND is_active = true

[HDGETPHO]
dsn=asterisk
readsql=SELECT id FROM structure_phone WHERE hash = '${SQL_ESC(${ARG1})}';

[HDNULL]
dsn=asterisk
writesql=DELETE FROM structure_employee_has_phone WHERE employee_id = ${SQL_ESC(${ARG1})} AND phone_id = ${SQL_ESC(${ARG2})};

[HDUP]
dsn=asterisk
writesql=INSERT INTO structure_employee_has_phone (employee_id, phone_id) VALUES (${SQL_ESC(${ARG1})},${SQL_ESC(${ARG2})});

;--------------------------------------

;II

[IIGETRECHASH]
dsn=asterisk
readsql=SELECT p.hash FROM structure_phone p LEFT JOIN structure_company c ON c.id = p.company_id LEFT JOIN structure_employee_has_phone ep ON ep.phone_id = p.id LEFT JOIN structure_employee e ON e.id = ep.employee_id WHERE e.extension = ${SQL_ESC(${ARG1})} AND c.id = ${SQL_ESC(${ARG2})}

[IIGETCOM]
dsn=asterisk
readsql=SELECT c.id FROM structure_company c LEFT JOIN structure_phone p ON p.company_id = c.id WHERE p.name = '${SQL_ESC(${ARG1})}'

[IIGETDIAPHO]
dsn=asterisk
readsql=SELECT p.id FROM structure_phone p WHERE p.name = '${SQL_ESC(${ARG1})}'

[IIGETRECEMP]
dsn=asterisk
readsql=SELECT e.id FROM structure_employee e WHERE e.extension = '${SQL_ESC(${ARG1})}' AND e.company_id = ${SQL_ESC(${ARG2})}

[IIGETSIPS]
dsn=asterisk
readsql=SELECT GROUP_CONCAT(CONCAT('SIP/',p.name) SEPARATOR '&') FROM structure_phone p LEFT JOIN structure_employee_has_phone ep ON ep.phone_id = p.id LEFT JOIN structure_employee e ON e.id = ep.employee_id WHERE e.id = ${SQL_ESC(${ARG1})}

[GETDIAPHONAME]
dsn=asterisk
readsql=SELECT p.phone_name FROM structure_phone p WHERE p.id = ${SQL_ESC(${ARG1})}

[GETRECEMPNAME]
dsn=asterisk
readsql=SELECT e.name FROM structure_employee e WHERE e.id = ${SQL_ESC(${ARG1})}

;--------------------------------------
;IO

[IOGETCOM]
dsn=asterisk
readsql=SELECT structure_company.id FROM structure_company LEFT JOIN structure_phone ON structure_phone.company_id = structure_company.id WHERE structure_phone.hash = '${SQL_ESC(${ARG1})}'

[IOGETDIAEMP]
dsn=asterisk
readsql=SELECT employee_id FROM structure_phone WHERE hash = '${SQL_ESC(${ARG1})}' AND structure_phone.is_active = 1

[IOGETDIAPHO]
dsn=asterisk
readsql=SELECT id FROM structure_phone WHERE hash = '${SQL_ESC(${ARG1})}' AND structure_phone.is_active = 1 

[IOSUBUNAME]
dsn=asterisk
readsql=SELECT username FROM structure_out_line WHERE id = ${SQL_ESC(${ARG1})};

[IOGETRATEID]
dsn=asterisk
readsql=SELECT id FROM bill_rate WHERE prefix = LEFT('${SQL_ESC(${ARG1})}',1) OR prefix = LEFT('${SQL_ESC(${ARG1})}',2) OR prefix = LEFT('${SQL_ESC(${ARG1})}',3) OR prefix = LEFT('${SQL_ESC(${ARG1})}',4) OR prefix = LEFT('${SQL_ESC(${ARG1})}',5) OR prefix = LEFT('${SQL_ESC(${ARG1})}',6) OR prefix = LEFT('${SQL_ESC(${ARG1})}',7) OR prefix = LEFT('${SQL_ESC(${ARG1})}',8) ORDER BY prefix_precision DESC LIMIT 1;

[IOGETRATE]
dsn=asterisk
readsql=SELECT rate FROM bill_rate WHERE id = ${SQL_ESC(${ARG1})}

[IOGETGROUP]
dsn=asterisk
readsql=SELECT outgroup_id FROM structure_company WHERE id = ${SQL_ESC(${ARG1})}

[IOGETLINE]
dsn=asterisk
readsql=SELECT structure_out_line.id FROM structure_out_line LEFT JOIN structure_outline_has_rate ON structure_outline_has_rate.outline_id = structure_out_line.id LEFT JOIN structure_outgroup_has_outline ON structure_outgroup_has_outline.outline_id = structure_out_line.id WHERE structure_outgroup_has_outline.outgroup_id = ${SQL_ESC(${ARG1})} AND structure_outline_has_rate.rate_id = ${SQL_ESC(${ARG2})} ORDER BY prec DESC

[IOGETDID]
dsn=asterisk
readsql=SELECT s.did FROM structure_subscription s LEFT JOIN structure_company cp ON cp.id = s.id LEFT JOIN structure_subscription_has_country sc ON sc.subscription_id = s.id LEFT JOIN structure_country c ON c.id = sc.country_id WHERE cp.id = ${SQL_ESC(${ARG2})} AND (c.call_code = LEFT('${SQL_ESC(${ARG1})}',1) OR c.call_code = LEFT('${SQL_ESC(${ARG1})}',2) OR c.call_code = LEFT('${SQL_ESC(${ARG1})}',3) OR c.call_code = LEFT('${SQL_ESC(${ARG1})}',4) OR c.call_code = LEFT('${SQL_ESC(${ARG1})}',5) OR c.call_code = LEFT('${SQL_ESC(${ARG1})}',6) OR c.call_code = LEFT('${SQL_ESC(${ARG1})}',7) OR c.call_code = LEFT('${SQL_ESC(${ARG1})}',8) ORDER BY CHAR_LENGTH(c.call_code) DESC LIMIT 1);
;--------------------------------------

;OI

[OIGETDATA]
dsn=asterisk
readsql=SELECT c.id, s.id, s.name, c.voicemail_id FROM structure_company c LEFT JOIN structure_subscription s ON s.company_id = c.id WHERE s.did = ${SQL_ESC(${ARG1})}

[OIGETSIPS]
dsn=asterisk
readsql=SELECT COUNT(p.id), GROUP_CONCAT(CONCAT('SIP/',p.name) SEPARATOR '&') FROM structure_subscription s LEFT JOIN structure_subscription_has_employee se ON se.subscription_id = s.id LEFT JOIN structure_employee e ON e.id = se.employee_id LEFT JOIN structure_employee_has_phone ep ON ep.employee_id = e.id LEFT JOIN structure_phone p ON ep.phone_id = p.id WHERE s.id = '${SQL_ESC(${ARG1})}'